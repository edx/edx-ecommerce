language: python

branches:
  only:
    - master

sudo: required
services:
  - docker

cache:
  - pip
  - directories:
    - node_modules
    - ecommerce/static/bower_components

addons:
  apt:
    packages:
      - lcov

before_install:
  - docker-compose -f ./.travis/docker-compose-travis.yml up -d

install:
  - docker exec -t ecommerce_testing bash -c '
      cd /edx/app/ecommerce/ecommerce/ &&
      pip install tox
    '
script:
  - docker exec -t
      -e TRAVIS=1
      -e TOXENV=$TOXENV
      ecommerce_testing
      bash -c '
      cd /edx/app/ecommerce/ecommerce/ &&
      PATH=$PATH:/edx/app/ecommerce/nodeenvs/ecommerce/bin:/snap/bin
      tox
    '

matrix:
  include:
    - python: 2.7
      env: TESTNAME=quality-and-js TOXENV=quality
    - python: 2.7
      env: TESTNAME=test-python TOXENV=py27
    - python: 3.5
      env: TESTNAME=test-python-3.5 TOXENV=py35
      after_success:
        - pip install -U codecov
        - docker exec ecommerce_testing /edx/app/ecommerce/ecommerce/.travis/run_coverage.sh
        - codecov
